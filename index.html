<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãŠå£ãƒã‚«ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆçµæœã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <style>
    body{
      margin:0;
      background:#222;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      display:flex;
      justify-content:center;
      padding:10px;
      box-sizing:border-box;
    }
    #layout{
      display:flex;
      gap:12px;
      align-items:flex-start;
      width:min(980px, 100%);
    }
    #left{
      display:flex;
      flex-direction:column;
      align-items:center;
      flex: 1;
      min-width: 320px;
    }
    #controlRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .ctrlBtn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      font-weight:bold;
      cursor:pointer;
    }
    .ctrlBtn:disabled{opacity:.4;cursor:default;}
    #startBtn{background:#1976d2;color:#fff;}
    #pauseBtn{background:#ffb300;color:#000;}
    #stopBtn{background:#757575;color:#fff;}
    #saveBtn{background:#26a69a;color:#fff;}

    #wrap{
      margin-top:8px;
      width:min(95vw,480px);
      padding:14px;
      border:18px solid #2e7d32; /* closed = green */
      border-radius:26px;
      background:#111;
      transition: border-color .15s ease, border-width .15s ease;
      box-sizing:border-box;
    }
    #wrap.open{
      border-color:#e53935; /* open = red */
      border-width:20px;
    }

    video{display:none;}
    canvas{
      width:100%;
      height:auto;
      border-radius:16px;
      background:#000;
      display:block;
    }

    #status{
      margin-top:8px;
      padding:8px 14px;
      border-radius:999px;
      font-weight:bold;
      text-align:center;
      min-width:min(80vw, 340px);
      background:#1976d2;
    }

    #resultBox{
      margin-top:10px;
      width:min(95vw, 480px);
      background:#2b2b2b;
      border-radius:16px;
      padding:10px 12px;
      box-sizing:border-box;
      font-size:14px;
      line-height:1.7;
    }
    #resultBox .label{opacity:.85; margin-right:6px;}
    #resultBox .value{font-weight:700;}
    #clinic{
      margin-top:8px;
      font-weight:700;
      opacity:.95;
    }

    /* Right panel (compact) */
    #right{
      background:#333;
      padding:12px;
      border-radius:16px;
      width:170px;
      height:fit-content;      /* â† ä¼¸ã³ãªã„ */
      align-self:flex-start;   /* â† ä¼¸ã³ãªã„ */
      box-sizing:border-box;
    }
    #rightTitle{font-weight:800;margin-bottom:6px;}
    .timerBtn{
      width:100%;
      margin:4px 0;
      padding:8px;
      border-radius:999px;
      border:none;
      background:#555;
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .timerBtn.active{background:#ffb300;color:#000;}
    #selectedLabel{margin-top:6px;font-size:12px;opacity:.9;}

    @media (max-width: 900px){
      #layout{flex-direction:column;align-items:center;}
      #right{width:min(95vw,480px);}
    }
  </style>
</head>

<body>
  <div id="layout">

    <!-- LEFT -->
    <div id="left">
      <div id="controlRow">
        <button id="startBtn" class="ctrlBtn">è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="pauseBtn" class="ctrlBtn" disabled>ä¸­æ–­</button>
        <button id="stopBtn"  class="ctrlBtn" disabled>ä¸­æ­¢</button>
        <button id="saveBtn"  class="ctrlBtn" disabled>çµæœä¿å­˜CSV</button>
      </div>

      <div id="wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" width="480" height="360"></canvas>
      </div>

      <div id="status">æº–å‚™ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</div>

      <!-- çµæœï¼ˆå¿…è¦ãª4é …ç›®ã ã‘ï¼‰ -->
      <div id="resultBox">
        <div><span class="label">æ—¥æ™‚ï¼š</span><span id="resultDate" class="value">â€”</span></div>
        <div><span class="label">é–‰ã˜ã¦ã„ãŸæ™‚é–“ï¼š</span><span id="closedTime" class="value">00:00</span></div>
        <div><span class="label">é–‹ã„ã¦ã„ãŸæ™‚é–“ï¼š</span><span id="openTime" class="value">00:00</span></div>
        <div><span class="label">ãƒã‚«ãƒ³ç‡ï¼š</span><span id="openRate" class="value">0</span><span class="value">%</span></div>
      </div>

      <div id="clinic">ğŸŒ» ã²ã¾ã‚ã‚ŠçŸ¯æ­£ãƒ»å°å…æ­¯ç§‘</div>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <div id="rightTitle">è¨ˆæ¸¬æ™‚é–“</div>
      <button class="timerBtn active" data-min="30">30åˆ†</button>
      <button class="timerBtn" data-min="10">10åˆ†</button>
      <button class="timerBtn" data-min="60">60åˆ†</button>
      <div id="selectedLabel">é¸æŠï¼š<span id="selectedMin">30</span>åˆ†</div>
    </div>

  </div>

  <!-- ğŸ”Š éŸ³ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãï¼‰ -->
  <audio id="alert"   src="pokan_checker_30s_tempo_up_v4.mp3" preload="auto"></audio>
  <audio id="success" src="pokan_success_kiran_v3.mp3" preload="auto"></audio>

  <script>
    /* ====== è¨­å®š ====== */
    const OPEN_THRESHOLD = 0.005;

    /* ====== DOM ====== */
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const wrap = document.getElementById("wrap");
    const statusBox = document.getElementById("status");

    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const saveBtn  = document.getElementById("saveBtn");

    const timerBtns = document.querySelectorAll(".timerBtn");
    const selectedMinEl = document.getElementById("selectedMin");

    const alertSound = document.getElementById("alert");
    const successSound = document.getElementById("success");

    // çµæœè¡¨ç¤ºï¼ˆ4é …ç›®ï¼‰
    const resultDateEl = document.getElementById("resultDate");
    const closedTimeEl = document.getElementById("closedTime");
    const openTimeEl   = document.getElementById("openTime");
    const openRateEl   = document.getElementById("openRate");

    /* ====== çŠ¶æ…‹ ====== */
    let totalTimeSec = 30 * 60;

    let started = false;
    let paused  = false;

    let lastTs = null;         // ç§’
    let totalElapsed = 0;      // ç§’
    let openElapsed  = 0;      // ç§’

    let wasOpen = false;
    let lastResultIso = null;

    /* ====== util ====== */
    function fmt(sec){
      sec = Math.max(0, sec);
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }
    function updateResultUI(){
      const closedSec = Math.max(0, totalElapsed - openElapsed);
      const rate = Math.round(openElapsed / Math.max(totalElapsed, 0.1) * 100);

      closedTimeEl.textContent = fmt(closedSec);
      openTimeEl.textContent   = fmt(openElapsed);
      openRateEl.textContent   = String(rate);
    }

    /* ====== éŸ³ã®è§£æ”¾ï¼ˆiOS/Chromeå¯¾ç­–ï¼‰ ====== */
    async function unlockAudio(){
      try{
        // v4
        alertSound.muted = true;
        await alertSound.play();
        alertSound.pause();
        alertSound.currentTime = 0;
        alertSound.muted = false;

        // kiran
        successSound.muted = true;
        await successSound.play();
        successSound.pause();
        successSound.currentTime = 0;
        successSound.muted = false;
      }catch(e){
        // ã“ã“ã§æ­¢ã‚ãªã„ï¼ˆç„¡åå¿œé˜²æ­¢ï¼‰
      }
    }
    function stopAlert(){
      alertSound.pause();
      alertSound.currentTime = 0;
    }
    function playAlert(){
      // v4ãŒã€Œèª­ã¿è¾¼ã¿ã§ãã¦ãªã„ã€å ´åˆã§ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
      alertSound.loop = true;
      alertSound.play().catch(()=>{});
    }
    function playKiran(){
      successSound.currentTime = 0;
      successSound.play().catch(()=>{});
    }

    /* ====== ã‚¿ã‚¤ãƒãƒ¼åˆ‡æ›¿ ====== */
    timerBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(started) return;
        timerBtns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const min = Number(btn.dataset.min);
        totalTimeSec = min * 60;
        selectedMinEl.textContent = String(min);
      });
    });

    /* ====== MediaPipe ====== */
    const faceMesh = new FaceMesh({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
    });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults((res)=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(res.image) ctx.drawImage(res.image,0,0,canvas.width,canvas.height);

      const now = performance.now()/1000;

      // deltaã¯å¸¸ã«ã“ã“ã§1å›ã ã‘è¨ˆç®—ï¼ˆæ­¢ã¾ã‚‰ãªã„ï¼‰
      let delta = 0;
      if(lastTs !== null) delta = now - lastTs;
      lastTs = now;

      const hasFace = !!(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0);

      // å£åˆ¤å®šï¼ˆé¡”ãŒãªã„æ™‚ã¯é–‰å£æ‰±ã„ï¼‰
      let isOpen = false;
      if(hasFace){
        const lm = res.multiFaceLandmarks[0];
        const diff = Math.abs(lm[13].y - lm[14].y);
        isOpen = diff > OPEN_THRESHOLD;
      }

      // è¨ˆæ¸¬ä¸­ï¼šæ™‚é–“åŠ ç®—ï¼ˆé¡”ãŒãªãã¦ã‚‚ total ã¯é€²ã‚ã‚‹ï¼‰
      if(started && !paused){
        totalElapsed += delta;
        if(isOpen) openElapsed += delta;
        updateResultUI();

        // çµ‚äº†åˆ¤å®š
        if(totalElapsed >= totalTimeSec){
          finishMeasurement();
          return;
        }
      }

      // è¡¨ç¤ºï¼ˆé¡”ãŒãªã„æ™‚ï¼‰
      if(!hasFace){
        if(started && !paused){
          statusBox.textContent = "é¡”ã‚’æ­£é¢ã«å‘ã‘ã¦ã­ ğŸ™‚";
          statusBox.style.background = "#757575";
        }else{
          statusBox.textContent = "æº–å‚™OKã€‚è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
          statusBox.style.background = "#1976d2";
        }
        // èª¤è­¦å‘Šé˜²æ­¢ã§éŸ³ã¨æ ã‚’æˆ»ã™
        stopAlert();
        wrap.classList.remove("open");
        wasOpen = false;
        return;
      }

      // çŠ¶æ…‹é·ç§»ï¼ˆè¨ˆæ¸¬ä¸­ã ã‘ï¼‰
      if(started && !paused){
        if(!wasOpen && isOpen){
          wrap.classList.add("open");
          statusBox.textContent = "ãŠå£ï¼šã‚ã„ã¦ã‚‹ã‚ˆ ğŸ˜®";
          statusBox.style.background = "#e53935";
          playAlert();
        }
        if(wasOpen && !isOpen){
          wrap.classList.remove("open");
          statusBox.textContent = "ãŠå£ï¼šã¨ã˜ã¦ã‚‹ã­ ğŸ‘";
          statusBox.style.background = "#43a047";
          stopAlert();
          playKiran();
        }
        wasOpen = isOpen;
      }else{
        // è¨ˆæ¸¬å‰
        statusBox.textContent = "æº–å‚™OKã€‚è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        statusBox.style.background = "#1976d2";
        wrap.classList.remove("open");
        stopAlert();
        wasOpen = false;
      }
    });

    const camera = new Camera(video, {
      onFrame: async ()=>{ await faceMesh.send({image: video}); },
      width: 480,
      height: 360
    });
    camera.start();

    /* ====== è¨ˆæ¸¬åˆ¶å¾¡ ====== */
    function resetMeasurementUI(){
      closedTimeEl.textContent = "00:00";
      openTimeEl.textContent   = "00:00";
      openRateEl.textContent   = "0";
      // æ—¥æ™‚ã¯é–‹å§‹æ™‚ã«å…¥ã‚Œã‚‹
    }

    function startMeasurement(){
      started = true;
      paused = false;

      totalElapsed = 0;
      openElapsed  = 0;
      lastTs = null;
      wasOpen = false;

      const iso = new Date().toISOString();
      lastResultIso = iso;
      resultDateEl.textContent = iso.replace("T"," ").replace("Z","");

      resetMeasurementUI();
      updateResultUI();

      startBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled  = false;
      saveBtn.disabled  = true;

      pauseBtn.textContent = "ä¸­æ–­";

      statusBox.textContent = "è¨ˆæ¸¬ä¸­â€¦";
      statusBox.style.background = "#1976d2";
    }

    function finishMeasurement(){
      started = false;
      paused = false;

      stopAlert();
      wrap.classList.remove("open");

      statusBox.textContent = "è¨ˆæ¸¬çµ‚äº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ ğŸŒ»";
      statusBox.style.background = "#555";

      startBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled  = true;
      saveBtn.disabled  = false;
    }

    function stopMeasurement(){
      started = false;
      paused = false;

      stopAlert();
      wrap.classList.remove("open");

      statusBox.textContent = "åœæ­¢ã—ã¾ã—ãŸ";
      statusBox.style.background = "#757575";

      startBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled  = true;
      saveBtn.disabled  = (totalElapsed <= 0);

      pauseBtn.textContent = "ä¸­æ–­";
    }

    /* ====== ãƒœã‚¿ãƒ³ ====== */
    startBtn.addEventListener("click", async ()=>{
      await unlockAudio(); // â† ã“ã‚ŒãŒãªã„ã¨v4ãŒé³´ã‚‰ãªã„ã“ã¨ãŒã‚ã‚‹
      startMeasurement();
    });

    pauseBtn.addEventListener("click", ()=>{
      if(!started) return;
      paused = !paused;

      if(paused){
        stopAlert();
        statusBox.textContent = "ä¸­æ–­ä¸­ï¼ˆå†é–‹ã§ãã¾ã™ï¼‰";
        statusBox.style.background = "#757575";
        pauseBtn.textContent = "å†é–‹";
      }else{
        lastTs = null; // å†é–‹æ™‚ã®deltaæš´èµ°é˜²æ­¢
        statusBox.textContent = "å†é–‹ï¼";
        statusBox.style.background = "#1976d2";
        pauseBtn.textContent = "ä¸­æ–­";
      }
    });

    stopBtn.addEventListener("click", ()=>{
      stopMeasurement();
    });

    /* ====== CSVä¿å­˜ï¼š4é …ç›®ã ã‘ï¼ˆ1è¡Œï¼‰ ====== */
    saveBtn.addEventListener("click", ()=>{
      const iso = lastResultIso || new Date().toISOString();
      const closedSec = Math.max(0, totalElapsed - openElapsed);
      const rate = Math.round(openElapsed / Math.max(totalElapsed, 0.1) * 100);

      const header = "date_iso,closed_time,open_time,open_rate_percent\n";
      const row =
        `${iso},${fmt(closedSec)},${fmt(openElapsed)},${rate}\n`;

      const blob = new Blob([header + row], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `pokan_summary_${iso.replace(/[:.]/g,"-")}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      statusBox.textContent = "CSVã‚’ä¿å­˜ã—ã¾ã—ãŸ âœ…";
      statusBox.style.background = "#26a69a";
      setTimeout(()=>{
        statusBox.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„";
        statusBox.style.background = "#1976d2";
      }, 900);
    });

    // åˆæœŸè¡¨ç¤º
    statusBox.textContent = "æº–å‚™ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    statusBox.style.background = "#1976d2";
    resultDateEl.textContent = "â€”";
  </script>
</body>
</html>
