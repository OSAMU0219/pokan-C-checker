<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãŠå£ãƒã‚«ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆv3ãƒ»æœ€çµ‚å®‰å®šç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <style>
    body{
      margin:0;background:#222;color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      display:flex;justify-content:center;padding:10px;box-sizing:border-box;
    }
    #layout{
      display:flex;gap:12px;align-items:flex-start;
      width:min(980px, 100%);
    }
    #left{display:flex;flex-direction:column;align-items:center;flex:1;min-width:320px;}
    #controlRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}

    .ctrlBtn{
      padding:8px 16px;border-radius:999px;border:none;
      font-weight:bold;cursor:pointer;
    }
    .ctrlBtn:disabled{opacity:.4;cursor:default;}
    #startBtn{background:#1976d2;color:#fff;}
    #pauseBtn{background:#ffb300;color:#000;}
    #stopBtn{background:#757575;color:#fff;}

    #wrap{
      margin-top:8px;width:min(95vw,480px);
      padding:14px;border:18px solid #2e7d32;border-radius:26px;
      background:#111;transition:border-color .15s ease,border-width .15s ease;
      box-sizing:border-box;
    }
    #wrap.open{border-color:#e53935;border-width:20px;}

    video{display:none;}
    canvas{width:100%;height:auto;border-radius:16px;background:#000;display:block;}

    #status{
      margin-top:8px;padding:8px 14px;border-radius:999px;
      font-weight:bold;text-align:center;min-width:min(80vw,340px);
      background:#1976d2;
    }

    /* çµæœï¼ˆ4é …ç›®ã ã‘ï¼‰ */
    #resultBox{
      margin-top:10px;width:min(95vw,480px);
      background:#2b2b2b;border-radius:16px;padding:10px 12px;
      box-sizing:border-box;font-size:14px;line-height:1.7;
    }
    #resultBox .label{opacity:.85;margin-right:6px;}
    #resultBox .value{font-weight:900;}

    #appName{
      margin-top:10px;
      font-size:18px;
      font-weight:900;
      letter-spacing:0.04em;
      opacity:0.95;
    }

    /* Right panel (compact) */
    #right{
      background:#333;padding:12px;border-radius:16px;width:170px;
      height:fit-content;align-self:flex-start;box-sizing:border-box;
    }
    #rightTitle{font-weight:900;margin-bottom:6px;}
    .timerBtn{
      width:100%;margin:4px 0;padding:8px;border-radius:999px;border:none;
      background:#555;color:#fff;font-weight:900;cursor:pointer;
    }
    .timerBtn.active{background:#ffb300;color:#000;}
    #selectedLabel{margin-top:6px;font-size:12px;opacity:.9;}

    @media (max-width: 900px){
      #layout{flex-direction:column;align-items:center;}
      #right{width:min(95vw,480px);}
    }
  </style>
</head>

<body>
  <div id="layout">

    <!-- LEFT -->
    <div id="left">
      <div id="controlRow">
        <button id="startBtn" class="ctrlBtn">è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="pauseBtn" class="ctrlBtn" disabled>ä¸­æ–­</button>
        <button id="stopBtn"  class="ctrlBtn" disabled>ä¸­æ­¢</button>
      </div>

      <div id="wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" width="480" height="360"></canvas>
      </div>

      <div id="status">æº–å‚™ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰</div>

      <!-- çµæœï¼ˆ4é …ç›®ã®ã¿ï¼‰ -->
      <div id="resultBox">
        <div><span class="label">æ—¥æ™‚ï¼š</span><span id="resultDate" class="value">â€”</span></div>
        <div><span class="label">é–‰ã˜ã¦ã„ãŸæ™‚é–“ï¼š</span><span id="closedTime" class="value">00:00</span></div>
        <div><span class="label">é–‹ã„ã¦ã„ãŸæ™‚é–“ï¼š</span><span id="openTime" class="value">00:00</span></div>
        <div><span class="label">ãƒã‚«ãƒ³ç‡ï¼š</span><span id="openRate" class="value">0</span><span class="value">%</span></div>
      </div>

      <div id="appName">ãŠå£ãƒã‚«ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼</div>
    </div>

    <!-- RIGHT -->
    <div id="right">
      <div id="rightTitle">è¨ˆæ¸¬æ™‚é–“</div>
      <button class="timerBtn active" data-min="30">30åˆ†</button>
      <button class="timerBtn" data-min="10">10åˆ†</button>
      <button class="timerBtn" data-min="60">60åˆ†</button>
      <div id="selectedLabel">é¸æŠï¼š<span id="selectedMin">30</span>åˆ†</div>
    </div>

  </div>

  <!-- ğŸ”Š éŸ³ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ãï¼‰ -->
  <!-- BGMï¼ˆå£ãŒé–‹ã„ãŸã‚‰æµã‚Œã‚‹ï¼‰ -->
  <audio id="alert" src="pokan_checker_30s_tempo_up_v3.mp3" preload="auto" playsinline></audio>
  <!-- ã‚­ãƒ©ãƒ³ï¼ˆå£ã‚’é–‰ã˜ãŸã‚‰é³´ã‚‹ï¼‰ -->
  <audio id="success" src="pokan_success_kiran_v3.mp3" preload="auto" playsinline></audio>

  <script>
    /* ====== è¨­å®š ====== */
    const OPEN_THRESHOLD = 0.005;

    /* ====== DOM ====== */
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const wrap = document.getElementById("wrap");
    const statusBox = document.getElementById("status");

    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn  = document.getElementById("stopBtn");

    const timerBtns = document.querySelectorAll(".timerBtn");
    const selectedMinEl = document.getElementById("selectedMin");

    const alertSound = document.getElementById("alert");
    const successSound = document.getElementById("success");

    // çµæœè¡¨ç¤ºï¼ˆ4é …ç›®ï¼‰
    const resultDateEl = document.getElementById("resultDate");
    const closedTimeEl = document.getElementById("closedTime");
    const openTimeEl   = document.getElementById("openTime");
    const openRateEl   = document.getElementById("openRate");

    /* ====== çŠ¶æ…‹ ====== */
    let totalTimeSec = 30 * 60;

    let started = false;
    let paused  = false;

    let lastTs = null;         // ç§’
    let totalElapsed = 0;      // ç§’
    let openElapsed  = 0;      // ç§’

    let wasOpen = false;

    // æ—¥æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“è¡¨ç¤ºç”¨ï¼‰
    let lastResultText = null;

    /* ====== util ====== */
    function fmt(sec){
      sec = Math.max(0, sec);
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }

    // æ—¥æœ¬æ™‚é–“ã®è¡¨ç¤ºæ–‡å­—åˆ—
    function nowJSTText(){
      const d = new Date();
      const y = d.getFullYear();
      const mo = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const h  = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${y}-${mo}-${da} ${h}:${mi}`;
    }

    function updateResultUI(){
      const closedSec = Math.max(0, totalElapsed - openElapsed);
      const rate = Math.round(openElapsed / Math.max(totalElapsed, 0.1) * 100);

      closedTimeEl.textContent = fmt(closedSec);
      openTimeEl.textContent   = fmt(openElapsed);
      openRateEl.textContent   = String(rate);
    }

    /* ====== éŸ³ã®è§£æ”¾ï¼ˆé‡è¦ï¼‰ ====== */
    async function unlockAudio(){
      try{
        // BGM
        alertSound.muted = true;
        await alertSound.play();
        alertSound.pause();
        alertSound.currentTime = 0;
        alertSound.muted = false;

        // ã‚­ãƒ©ãƒ³
        successSound.muted = true;
        await successSound.play();
        successSound.pause();
        successSound.currentTime = 0;
        successSound.muted = false;
      }catch(e){
        // ã“ã“ã§æ­¢ã‚ãªã„
      }
    }

    /* ====== BGMç¢ºå®Ÿåˆ¶å¾¡ ====== */
    function playAlert(){
      if (!alertSound.paused) return; // äºŒé‡å†ç”Ÿé˜²æ­¢
      alertSound.loop = true;
      alertSound.volume = 1.0;
      alertSound.currentTime = 0;
      alertSound.play().catch(()=>{});
    }

    function stopAlert(){
      if (alertSound.paused) return;
      alertSound.pause();
      alertSound.currentTime = 0;
    }

    function playKiran(){
      successSound.currentTime = 0;
      successSound.play().catch(()=>{});
    }

    /* ====== ã‚¿ã‚¤ãƒãƒ¼åˆ‡æ›¿ ====== */
    timerBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(started) return;
        timerBtns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const min = Number(btn.dataset.min);
        totalTimeSec = min * 60;
        selectedMinEl.textContent = String(min);
      });
    });

    /* ====== MediaPipe ====== */
    const faceMesh = new FaceMesh({
      locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
    });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults((res)=>{
      // æç”»
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(res.image) ctx.drawImage(res.image,0,0,canvas.width,canvas.height);

      // æ™‚é–“
      const now = performance.now()/1000;
      let delta = 0;
      if(lastTs !== null) delta = now - lastTs;
      lastTs = now;

      const hasFace = !!(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0);

      // å£åˆ¤å®š
      let isOpen = false;
      if(hasFace){
        const lm = res.multiFaceLandmarks[0];
        const diff = Math.abs(lm[13].y - lm[14].y);
        isOpen = diff > OPEN_THRESHOLD;
      }

      // è¨ˆæ¸¬ä¸­ï¼šæ™‚é–“åŠ ç®—ï¼ˆé¡”ãŒãªãã¦ã‚‚totalã¯é€²ã‚ã‚‹ï¼‰
      if(started && !paused){
        totalElapsed += delta;
        if(isOpen) openElapsed += delta;
        updateResultUI();

        if(totalElapsed >= totalTimeSec){
          finishMeasurement();
          return;
        }
      }

      // é¡”ãŒãªã„æ™‚ï¼ˆè¨ˆæ¸¬ä¸­ã¯BGMåœæ­¢ï¼‰
      if(!hasFace){
        if(started && !paused){
          statusBox.textContent = "é¡”ã‚’æ­£é¢ã«å‘ã‘ã¦ã­ ğŸ™‚";
          statusBox.style.background = "#757575";
        }else{
          statusBox.textContent = "æº–å‚™OKã€‚è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
          statusBox.style.background = "#1976d2";
        }
        stopAlert();
        wrap.classList.remove("open");
        wasOpen = false;
        return;
      }

      // å£ã®çŠ¶æ…‹å¤‰åŒ–ã ã‘ã§BGMã‚’åˆ¶å¾¡
      if (started && !paused) {
        if (isOpen && !wasOpen) {
          // é–‰ â†’ é–‹
          playAlert();
          wrap.classList.add("open");
          statusBox.textContent = "ãŠå£ï¼šã‚ã„ã¦ã‚‹ã‚ˆ ğŸ˜®";
          statusBox.style.background = "#e53935";
        }

        if (!isOpen && wasOpen) {
          // é–‹ â†’ é–‰
          stopAlert();
          playKiran();
          wrap.classList.remove("open");
          statusBox.textContent = "ãŠå£ï¼šã¨ã˜ã¦ã‚‹ã­ ğŸ‘";
          statusBox.style.background = "#43a047";
        }
      } else {
        // è¨ˆæ¸¬ã—ã¦ã„ãªã„/ä¸­æ–­ä¸­ã¯å¿…ãšæ­¢ã‚ã‚‹
        stopAlert();
        wrap.classList.remove("open");
        if (!started) {
          statusBox.textContent = "æº–å‚™OKã€‚è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
          statusBox.style.background = "#1976d2";
        }
      }

      wasOpen = isOpen;
    });

    const camera = new Camera(video, {
      onFrame: async ()=>{ await faceMesh.send({image: video}); },
      width: 480,
      height: 360
    });
    camera.start();

    /* ====== è¨ˆæ¸¬åˆ¶å¾¡ ====== */
    function startMeasurement(){
      started = true;
      paused = false;

      totalElapsed = 0;
      openElapsed  = 0;
      lastTs = null;
      wasOpen = false;

      lastResultText = nowJSTText();
      resultDateEl.textContent = lastResultText;

      updateResultUI();

      startBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled  = false;

      pauseBtn.textContent = "ä¸­æ–­";
      statusBox.textContent = "è¨ˆæ¸¬ä¸­â€¦";
      statusBox.style.background = "#1976d2";
    }

    function finishMeasurement(){
      started = false;
      paused  = false;

      stopAlert();
      wrap.classList.remove("open");

      statusBox.textContent = "è¨ˆæ¸¬çµ‚äº†ï¼ãŠã¤ã‹ã‚Œã•ã¾ ğŸŒ»";
      statusBox.style.background = "#555";

      startBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled  = true;
    }

    function stopMeasurement(){
      started = false;
      paused  = false;

      stopAlert();
      wrap.classList.remove("open");

      statusBox.textContent = "åœæ­¢ã—ã¾ã—ãŸ";
      statusBox.style.background = "#757575";

      startBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled  = true;

      pauseBtn.textContent = "ä¸­æ–­";
    }

    /* ====== ãƒœã‚¿ãƒ³ ====== */
    startBtn.addEventListener("click", async ()=>{
      await unlockAudio();   // ã“ã“ã§éŸ³ã‚’è§£æ”¾
      startMeasurement();
    });

    pauseBtn.addEventListener("click", ()=>{
      if(!started) return;
      paused = !paused;

      if(paused){
        stopAlert();
        statusBox.textContent = "ä¸­æ–­ä¸­ï¼ˆå†é–‹ã§ãã¾ã™ï¼‰";
        statusBox.style.background = "#757575";
        pauseBtn.textContent = "å†é–‹";
      }else{
        lastTs = null; // å†é–‹æ™‚deltaæš´èµ°é˜²æ­¢
        statusBox.textContent = "å†é–‹ï¼";
        statusBox.style.background = "#1976d2";
        pauseBtn.textContent = "ä¸­æ–­";
      }
    });

    stopBtn.addEventListener("click", ()=>{
      stopMeasurement();
    });

    // åˆæœŸè¡¨ç¤º
    statusBox.textContent = "æº–å‚™ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰";
    statusBox.style.background = "#1976d2";
    resultDateEl.textContent = "â€”";
    updateResultUI();
  </script>
</body>
</html>
